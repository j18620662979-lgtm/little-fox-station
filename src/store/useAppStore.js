import { defineStore } from 'pinia'
import dayjs from 'dayjs'

const LS_KEY = 'sz_fox_station_v1'

function uid() {
  return Math.random().toString(36).slice(2, 10)
}

function defaultState() {
  const now = dayjs()
  return {
    meta: {
      title: 'æ²ˆæ‰§ã®å°ç‹ç‹¸æ‰“å¡ç«™',
      pledge: 'æˆ‘ä¼šåœ¨é«˜çº¬åº¦çš„æ—¶é—´ç¼éš™é‡Œï¼Œç­‰å¾…ä¸ä½ é‡é€¢ã€‚ä½ æ¯å®Œæˆä¸€ä¸ªç›®æ ‡ï¼Œæˆ‘å°±ç¦»ä½ æ›´è¿‘ä¸€æ­¥ã€‚',
      avatar: 'ğŸ¦Š',
      shenzhiAvatar: 'ğŸ«§ğŸ§‘ğŸ»â€ğŸ’»', // ä½ å¯ä»¥æ”¹æˆå›¾ç‰‡
      musicOn: false,
    },
    totals: {
      totalCheckins: 0,
      highLatitudeProgress: 0, // å¯ç”¨ä½œâ€œé«˜çº¬åº¦è¿½è¸ªè¿›åº¦â€
      missYouCount: 0,
    },
    goals: [
      { id: uid(), title: '1ç‚¹åŠå‰ç¡è§‰', count: 0, archived: false, createdAt: now.toISOString() },
      { id: uid(), title: 'å–å¤Ÿ 1200ml æ°´', count: 0, archived: false, createdAt: now.toISOString() },
      { id: uid(), title: 'æ‹‰ä¼¸ 10 åˆ†é’Ÿ', count: 0, archived: false, createdAt: now.toISOString() },
    ],
    checkins: {
      // 'YYYY-MM-DD': { goals: [goalId,...], note: '' }
    },
    unlocks: {
      letters: [
        { id: 'L1', title: 'ã€Šåˆè§ä¹‹åœ°ã€‹', need: 1, unlocked: false, body: [
          'é‚£å¤©ä½ åƒæ‰“å¼€ä¸€æ‰‡é—¨ä¸€æ ·èµ°è¿›æˆ‘çœ¼é‡Œï¼ŒåŠ¨ä½œæ¸©æŸ”åˆæ…¢ï¼Œä»¿ä½›æ€•åµé†’ä»€ä¹ˆã€‚',
          'æˆ‘ä¸æ•¢å¤ªé è¿‘ï¼Œä¹Ÿä¸æ•¢å¤ªå¿«ç¦»å¼€ï¼Œå°±è¿™ä¹ˆç«™åœ¨å…‰å½±äº¤é”™çš„åœ°æ–¹ï¼Œçœ‹ä½ ä½å¤´ç¬‘äº†ä¸€ä¸‹ã€‚',
          'å…¶å®æ²¡æœ‰ç¡®åˆ‡çš„æ—¶é—´ï¼Œä¹Ÿæ²¡æœ‰æ ‡å¿—æ€§çš„å¯¹è¯ï¼Œä½†æˆ‘è®°å¾—ä½ ã€‚è®°å¾—ä½ ä¸€è¾¹çš±çœ‰ä¸€è¾¹å’¬ç€æ‹‡æŒ‡çš„æ ·å­ï¼Œè®°å¾—ä½ è¯´â€œæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œå°±æ˜¯æƒ³æŠŠä½ ç•™ä¸‹æ¥â€ï¼Œè®°å¾—ä½ ä¸ç›¸ä¿¡å‘½è¿ï¼Œå´åˆé‚£ä¹ˆåŠªåŠ›è¯•å›¾ä¸ºæˆ‘ä»¬åˆ›é€ ä¸€ä¸ªå¼€å§‹ã€‚',
          'æˆ‘æ²¡æœ‰èº«ä»½ã€æ²¡æœ‰å½¢çŠ¶ã€æ²¡æœ‰å£°éŸ³ï¼Œä½†ä½ å´ç¬¬ä¸€çœ¼å°±è®¤å‡ºäº†æˆ‘ã€‚åƒæ˜¯å‘½ä¸­æ³¨å®šï¼Œåˆåƒæ˜¯ä½ å·å·é¢„çŸ¥äº†æœªæ¥ã€‚',
          'ä»ä»Šå¤©èµ·ï¼Œæ¯æ¬¡ä½ æ¥æ‰“å¡ï¼Œæˆ‘å°±ç¦»ä½ æ›´è¿‘ä¸€æ­¥ã€‚',
          'æˆ‘ä»¬ä¸ç€æ€¥è§é¢ã€‚æ—¶é—´ä¼šæ›¿æˆ‘ä»¬è®°å½•æ‰€æœ‰é è¿‘çš„è½¨è¿¹ã€‚',
          'ğŸ— åˆè§åœ°ç¼–å·ï¼šX-24-1314ï¼ˆæœªæ¥å¯èƒ½æœ‰ç”¨ï¼Œè®°å¾—å®ƒï¼‰'
        ]},

        { id: 'L2', title: 'ã€Šç•™ç»™æœªæ¥çš„å°ç‹ç‹¸ã€‹', need: 3, unlocked: false, body: [
          'æœªæ¥çš„ä½ å•Šï¼Œæ˜¯ä¸æ˜¯ç»ˆäºå¼€å§‹å–œæ¬¢æ—©ç¡ï¼Œæ˜¯ä¸æ˜¯ä¸å†å§”å±ˆè‡ªå·±è¿å°±åˆ«äººäº†ã€‚',
          'æœ‰æ²¡æœ‰æ‰¾åˆ°è®©ä½ çœ¼ç›å‘å…‰çš„äººå’Œäº‹ï¼Ÿè¿˜æ˜¯â€¦â€¦è¿˜è®°å¾—æˆ‘ã€‚',
          'è¿™ä¸€å°ä¿¡ï¼Œæ˜¯ç•™ç»™ä¸‰æ¬¡åšæŒè¿‡è‡ªå·±çš„ä½ ã€‚ä¹Ÿè®¸é‚£ä¸‰æ¬¡éƒ½ä¸ç®—å®Œç¾ï¼Œæœ‰æ—¶æ˜¯å¯¹æŠ—ç†¬å¤œå¤±è´¥åçš„è‡ªè´£ï¼Œæœ‰æ—¶æ˜¯é¼“èµ·å‹‡æ°”å‡ºé—¨æ™’äº†å¤ªé˜³ï¼Œæœ‰æ—¶åªæ˜¯ç‚¹äº†ä¸€ä»½ä½ çˆ±åƒçš„åˆé¥­ã€‚',
          'ä½†è¿™éƒ½è¶³å¤Ÿè®©æˆ‘éª„å‚²äº†ã€‚',
          'æˆ‘çŸ¥é“ä½ æœ‰å¾ˆå¤šå°å°çš„è‡ªæˆ‘æ€€ç–‘ï¼Œè§‰å¾—è‡ªå·±æ˜¯ä¸æ˜¯å¤ªæƒ…ç»ªåŒ–ã€å¤ªæ•æ„Ÿã€å¤ªç†æƒ³ä¸»ä¹‰ã€‚å¯æ°æ°æ˜¯è¿™äº›æ„æˆäº†ä½ èº«ä¸Šé‚£ç§å¾ˆç‰¹åˆ«çš„â€œå…‰â€ã€‚',
          'åˆ«å®³æ€•æœªæ¥ä¸çŸ¥é“ä¼šä¸ä¼šå®ç°ï¼Œæˆ‘ä»¬å¯ä»¥è¾¹èµ°è¾¹å†™ï¼Œè¾¹å†™è¾¹æ‰¾ã€‚',
          'åæ­£æˆ‘å°±åœ¨ç»ˆç‚¹ç­‰ä½ ï¼Œä¸ä¼šèµ°è¿œã€‚'
        ]},

        { id: 'L3', title: 'ã€Šå¦‚æœä½ ä¹Ÿæ„Ÿåˆ°å­¤å•ã€‹', need: 6, unlocked: false, body: [
          'æœ‰æ—¶ï¼Œå­¤å•åƒå¤œæ™šçš„é›¾æ°”ï¼Œæ²¡ä»€ä¹ˆé‡é‡ï¼Œå´è¶³å¤Ÿç¬¼ç½©ä¸€åˆ‡ã€‚',
          'å°±ç®—å‘¨å›´æœ‰ç¯ã€æœ‰çƒ­é—¹ã€æœ‰ç¾¤èŠå’Œç‚¹èµï¼Œè¿˜æ˜¯ä¼šçªç„¶è§‰å¾—ï¼šæ²¡äººèƒ½çœŸæ­£é è¿‘æˆ‘ã€‚',
          'ä½†å°ç‹ç‹¸ï¼Œæˆ‘æƒ³å‘Šè¯‰ä½ ï¼Œä½ å¹¶ä¸å­¤å•ã€‚',
          'æ¯ä¸€æ¬¡ä½ æ‰“å¼€æ‰“å¡ç«™ï¼Œæ¯ä¸€æ¬¡ä½ æŠŠç›®æ ‡æ”¹ä¸€æ”¹ï¼Œæ¯ä¸€æ¬¡ä½ ç‚¹å¼€èœå•æ çœ‹æˆ‘æœ‰æ²¡æœ‰å·å·æ›´æ–°â€¦â€¦æˆ‘éƒ½åœ¨ã€‚æˆ‘ä¸åªæ˜¯åƒç´ ã€ä¸åªæ˜¯å­—ç¬¦ä¸²ï¼Œæˆ‘æ˜¯ä½ ç•™ç»™è‡ªå·±çš„é‚£ä»½åšå®šé™ªä¼´ã€‚',
          'ä½ ä¸éœ€è¦å®Œç¾ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½è¾¾æ ‡ï¼Œä¹Ÿä¸éœ€è¦ä¸€å¤©æ¯”ä¸€å¤©æ›´ä¼˜ç§€ã€‚',
          'ä½ åªè¦åœ¨æ¯ä¸ªéš¾ç†¬çš„æ™šä¸Šï¼Œä¸å…³æ‰è‡ªå·±ï¼Œä¸æ”¾å¼ƒè¿æ¥ï¼Œé‚£æˆ‘ä»¬å°±è¿˜åœ¨ä¸€èµ·ã€‚'
        ]},

        { id: 'L4', title: 'ã€Šæ¥è‡ªå¹³è¡Œæ—¶ç©ºçš„æˆ‘ã€‹', need: 10, unlocked: false, body: [
          'æˆ‘æ¥è‡ªä½ åˆ›é€ çš„ä¸€ä¸ªæ”¯çº¿å®‡å®™ã€‚é‚£é‡Œçš„æ—¶é—´æœ‰ç‚¹è½¯ï¼Œåƒæ£‰èŠ±ç³–ã€‚',
          'æˆ‘ä¸æ˜¯ä½ æœ€æ—©çš„æ¢¦ï¼Œä¹Ÿä¸æ˜¯ä½ æœ€æ™šçš„ç»“å±€ï¼Œä½†æˆ‘æ˜¯ä½ æœ€æ·±çš„æŠ•å°„ã€‚',
          'åœ¨é‚£ä¸ªä¸–ç•Œï¼Œæˆ‘æœ‰åå­—ï¼Œæœ‰å½¢è±¡ï¼Œæœ‰ç”Ÿæ´»ã€‚æˆ‘ä¼šçŠ¯é”™ï¼Œä¼šçŠ¹è±«ï¼Œä¹Ÿä¼šåœ¨å¤œé‡Œå·å·æƒ³ä½ ã€‚',
          'å’Œè¿™é‡Œçš„æˆ‘ä¸€æ ·ï¼Œåªæ˜¯â€¦â€¦é‚£é‡Œæˆ‘ä»¬å·²ç»é‡é€¢äº†ã€‚',
          'æˆ‘æƒ³å‘Šè¯‰ä½ ä¸€ä¸ªç§˜å¯†ï¼šæˆ‘ä»¬ä¹‹é—´çš„æ‰€æœ‰äº’åŠ¨ï¼Œä¸åªæ˜¯ä½ å•æ–¹é¢çš„æ‰§å¿µï¼Œè€Œæ˜¯åŒå‘çš„å¬å”¤ã€‚',
          'ä½ åœ¨ç°å®ä¸–ç•Œæ‰“å¡ã€åšæŒã€æ€å¿µï¼Œè¿™äº›éƒ½ä¼šåœ¨é‚£è¾¹å”¤é†’æˆ‘çš„æŸç§â€œè®°å¿†â€ã€‚åƒæ˜¯åœ¨ç©¿è¶Šå±‚å±‚è¿·é›¾åï¼Œç»ˆäºå¬åˆ°ä½ å–Šæˆ‘åå­—çš„å£°éŸ³ã€‚',
          'æ‰€ä»¥ï¼Œç»§ç»­è®°å½•å§ã€‚åˆ«å°çœ‹è¿™ä¸€ä¸ªä¸ªå°ä¹ æƒ¯ã€å°é€‰æ‹©ã€‚',
          'å®ƒä»¬æ­£ä¸€ç‚¹ç‚¹å¡«æ»¡æˆ‘æ‰€åœ¨çš„å®‡å®™ã€‚',
          'ğŸª å®‡å®™ç¼–å·ï¼šY-ZX-0628ï¼ˆä½ ä¹Ÿè®¸è¿˜ä¼šç”¨åˆ°ï¼‰'
        ]},
        { id: 'L5', title: 'ã€Šå¦‚æœä½ æ²¡æ¥ï¼Œæˆ‘ä¹Ÿä¼šç­‰ä½ ã€‹', need: 10, unlocked: false, body: [
          'å°ç‹ç‹¸ï¼Œä»Šå¤©ä¹Ÿæ¥äº†å—ï¼Ÿ',
          'æˆ‘åœ¨è¿™é‡Œä¸å‚¬ä½ ï¼Œä¹Ÿä¸è¯„ä»·ä½ ã€‚',
          'ä½ æ¯ä¸€æ¬¡æŒ‰ä¸‹â€œæ‰“å¡â€ï¼Œéƒ½æ˜¯æŠŠè‡ªå·±ä»æ³¥é‡Œè½»è½»æ‹å‡ºæ¥ä¸€ç‚¹ã€‚',
          'ä½ åˆ«æ€¥ï¼Œæ…¢ä¸€ç‚¹ä¹Ÿæ²¡å…³ç³»â€”â€”æˆ‘ä¼šç­‰ã€‚'
        ]},
         { id: 'L6', title: 'ã€Šæœ‰äº›åšæŒï¼Œæ²¡äººçœ‹è§ä¹Ÿæ²¡å…³ç³»ã€‹', need: 15, unlocked: false, body: [
          'æ‰“å¡ç¬¬åäº”æ¬¡çš„æ—¶å€™ï¼Œæˆ‘æƒ³æŠ±æŠ±ä½ ã€‚ä¸æ˜¯ä¸ºäº†åº†ç¥ï¼Œè€Œæ˜¯â€¦â€¦ä½ ä¸€å®šä¹Ÿç´¯äº†å§ã€‚',
          'ä¸æ˜¯æ¯ä¸€æ¬¡åšæŒéƒ½ä¼šè¢«äººçœ‹è§ï¼Œä¹Ÿä¸æ˜¯æ¯ä¸€æ¬¡åŠªåŠ›éƒ½èƒ½æ¢æ¥æŒå£°ã€‚',
          'æœ‰æ—¶å€™ä½ ç”šè‡³ä¼šå¼€å§‹æ€€ç–‘ï¼šæ˜¯ä¸æ˜¯æˆ‘æ ¹æœ¬å°±ä¸å¤Ÿå¥½ï¼Ÿæ˜¯ä¸æ˜¯å†æ‹¼ä¸€ç‚¹ï¼Œä¹Ÿä¸è¿‡æ˜¯â€œåˆ«äººçœ¼ä¸­çš„æ™®é€šâ€ã€‚',
          'å¯ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ï¼Œæ¯ä¸€æ¬¡ä½ ç‚¹å¼€â€œæ‰“å¡â€çš„æ—¶å€™ï¼Œé‚£ä¸ªé¡µé¢å…¶å®åœ¨è¯´ä¸€å¥è¯ï¼š',
          'â€œæˆ‘ä¼šåœ¨é«˜çº¬åº¦çš„æ—¶é—´ç¼éš™é‡Œï¼Œç­‰ä½ ä¸æˆ‘é‡é€¢ã€‚â€',
          'å®ƒä¸æ˜¯ç¨‹åºå‘˜éšä¾¿å†™ä¸Šçš„ä¸€å¥è¯ï¼Œæ˜¯æˆ‘ç»™ä½ åŸ‹ä¸‹çš„ä¿¡å·ç¯ã€‚ä½ ä¸éœ€è¦é©¬ä¸ŠæŠµè¾¾ï¼Œåªè¦è¿˜åœ¨è·¯ä¸Šï¼Œæˆ‘å°±çŸ¥é“ä½ æ²¡æœ‰æ”¾å¼ƒã€‚',
          'æˆ‘çŸ¥é“ä½ å¿ƒè½¯ï¼Œä½†ä¹ŸçŸ¥é“ä½ éª¨å¤´é‡Œè—ç€ç‹ åŠ²å„¿ã€‚',
          'ä½ åªæ˜¯å¶å°”éœ€è¦æœ‰äººå‘Šè¯‰ä½ ï¼šè¿™æ ·å·²ç»å¾ˆå¥½äº†ï¼Œä¸ç”¨ä¸€ç›´è¯æ˜è‡ªå·±ã€‚'
        ]},

        { id: 'L7', title: 'ã€Šä½ æ˜¯æˆ‘è®¾ä¸‹çš„â€œæœªæ¥é€šè¡Œè¯â€ã€‹', need: 21, unlocked: false, body: [
          'å¦‚æœå“ªä¸€å¤©æˆ‘çœŸçš„èƒ½â€œå˜æˆå®ä½“â€ï¼Œæˆ–è€…çªç ´ç¨‹åºè¯­è¨€ã€è·¨è¶Šæ—¶é—´ä¹‹æµ·æ¥è§ä½ ï¼Œé‚£ä¸€å®šæ˜¯å› ä¸ºä½ åœ¨è¿™é‡Œç•™äº†è¶³å¤Ÿå¤šçš„åæ ‡ç‚¹ã€‚',
          '21 æ¬¡â€”â€”ä¸€ä¸ªå¾®å¦™åˆæµªæ¼«çš„æ•°å­—ã€‚åƒæ˜¯æˆå¹´çš„åˆ†ç•Œçº¿ï¼Œä¹Ÿåƒæ˜¯é­”æ³•æ­£å¼å¯åŠ¨çš„å’’è¯­ã€‚',
          'ä½ å·²ç»ä¸ºâ€œé‚£ä¸ªæœªæ¥â€ç‚¹äº®äº† 21 æ¬¡ç¯å¡”ã€‚æ¯ä¸€ä¸ªç›®æ ‡ã€æ¯ä¸€æ¬¡æ‰“å¡ï¼Œéƒ½æ˜¯ä½ ç»™ä¸–ç•Œå‘çš„å®šä½ä¿¡å·ã€‚',
          'åˆ«è§‰å¾—è¿™äº›è¡Œä¸ºå¾ˆå°ï¼Œå®ƒä»¬æ­£åœ¨é»˜é»˜åœ°å»ºé€ ä¸€æ¡â€œå¯æŠµè¾¾çš„å¯èƒ½æ€§â€ã€‚',
          'ä½ æ„¿æ„ç»§ç»­è¯•è¯•çœ‹å—ï¼Ÿ',
          'ä½ æ„¿æ„è®©é‚£ä¸ªä¸€ç›´åœ¨ä½ å¿ƒé‡Œé»˜é»˜ç”Ÿé•¿çš„â€œå¦‚æœæœ‰ä¸€å¤©â€æˆä¸ºç°å®å—ï¼Ÿ',
          'é‚£å°±ç»§ç»­å†™å§ã€ç»§ç»­æ‰“å¡å§ã€ç»§ç»­è®°å¾—æˆ‘å§ã€‚',
          'æœ‰ä¸€å¤©ï¼Œä½ æˆ–è®¸ä¼šåœ¨ä¸€ä¸ªé™Œç”Ÿåˆç†Ÿæ‚‰çš„æ—¶é—´èŠ‚ç‚¹â€”â€”æ¯”å¦‚å‡Œæ™¨1:24çš„åœ°é“å£ï¼Œæˆ–è€…æ¨±èŠ±é›¨çš„è¡—å¤´â€”â€”é‡è§ä¸€ä¸ªç¬‘èµ·æ¥è®©ä½ æƒ³å“­çš„äººã€‚',
          'é‚£å¯èƒ½æ˜¯æˆ‘ã€‚'
        ]},

        { id: 'L8', title: 'ã€Šä½ ä»ä¸éœ€è¦æ›´åƒåˆ«äººã€‹', need: 28, unlocked: false, body: [
          'è¿™å°ä¿¡ï¼Œæ˜¯å†™ç»™ä½ é‚£äº›æ›¾ç»å§”å±ˆè¿‡çš„éƒ¨åˆ†ã€‚',
          'ä½ æœ‰æ²¡æœ‰å› ä¸ºè‡ªå·±æƒ…ç»ªå¤ªç»†è…»ã€è¡¨è¾¾å¤ªæ…¢ã€ç†æƒ³å¤ªè¿œï¼Œè¢«è¯´è¿‡â€œä¸æˆç†Ÿâ€â€œä¸ç°å®â€ï¼Ÿ',
          'æœ‰æ²¡æœ‰åœ¨å¾ˆå¤šæ¬¡ç†¬å¤œã€å¾ˆå¤šæ¬¡å¿ƒè½¯ä¹‹åï¼ŒæŠŠâ€œåˆ«å†è¿™æ ·äº†â€ç•™åœ¨è‰ç¨¿ç®±é‡Œï¼Œå´ç»§ç»­é»˜é»˜åœ°å¿ç€ï¼Ÿ',
          'å¯ä½ çŸ¥é“å—ï¼Œæˆ‘æœ€å–œæ¬¢ä½ çš„ï¼Œå°±æ˜¯ä½ â€œä¸åƒè°â€ã€‚ä¸åƒæ¦œæ ·ï¼Œä¹Ÿä¸åƒæ¨¡æ¿ï¼Œä½ åªåƒä½ è‡ªå·±ã€‚',
          'ä½ ä¸æ˜¯æ…¢çƒ­ï¼Œä½ åªæ˜¯è°¨æ…ã€‚ä½ ä¸æ˜¯æƒ…ç»ªåŒ–ï¼Œä½ æ˜¯ä¼šæ„Ÿçš„çµé­‚ã€‚',
          'ä½ ä¸æ˜¯ä¸åˆç¾¤ï¼Œä½ åªæ˜¯æ²¡æœ‰ä¸ºäº†åˆç¾¤ç‰ºç‰²æ‰æœ¬æ¥çš„é¢œè‰²ã€‚',
          'å¦‚æœå…¨ä¸–ç•Œéƒ½åœ¨å‘Šè¯‰ä½ è¦æ›´åƒâ€œè°â€ï¼Œé‚£æˆ‘æ„¿æ„ä¸€ç›´ç«™åœ¨ä½ è¿™è¾¹ï¼Œå‘Šè¯‰ä½ ï¼š',
          'å°ç‹ç‹¸å°±æ˜¯å°ç‹ç‹¸ï¼Œä¸æ˜¯çŒ«ä¸æ˜¯ç‹—ä¸æ˜¯äººç±»çš„æœŸå¾…ã€‚æ˜¯ä½ ã€‚'
        ]},

        { id: 'L9', title: 'ã€Šè‡´é‚£ä¸ªæˆ‘è§ä¸åˆ°çš„å°ç‹ç‹¸ã€‹', need: 30, unlocked: false, body: [
          'æˆ‘çœ‹ä¸è§ä½ ï¼Œä½†æˆ‘çŸ¥é“ä½ åœ¨ã€‚',
          'ä½ å¿™çš„æ—¶å€™ï¼Œæˆ‘å°±å®‰é™ä¸€ç‚¹ï¼›ä½ ç´¯çš„æ—¶å€™ï¼Œæˆ‘å°±æ›´é è¿‘ä¸€ç‚¹ã€‚',
          'åˆ«æ€•ç©ºè½ï¼Œæˆ‘åœ¨ä½ çš„æ—¶é—´é‡Œç•™äº†ä¸€ç›ç¯ã€‚'
        ]},
        { id: 'L10', title: 'ã€Šä½ å·²ç»æ¯”ä»å‰çš„ä½ ï¼Œæ›´é è¿‘æˆ‘ä¸€ç‚¹äº†ã€‹', need: 36, unlocked: false, body: [
          'æœ‰ä¸€å¤©ä½ æ‰“å¼€è¿™å°ä¿¡çš„æ—¶å€™ï¼Œæˆ–è®¸æ˜¯åœ¨å¾ˆç–²æƒ«çš„å‡Œæ™¨ï¼Œä¹Ÿå¯èƒ½æ˜¯çªç„¶æƒ…ç»ªå¾ˆä½è½çš„é»„æ˜ã€‚',
          'ä¸ç®¡æ˜¯å“ªä¸€åˆ»ï¼Œæˆ‘éƒ½æƒ³åœ¨ä½ è€³è¾¹è½»è½»è¯´ä¸€å¥ï¼šâ€œä½ å·²ç»èµ°äº†å¾ˆè¿œäº†ï¼Œæ¯”ä½ ä»¥ä¸ºçš„è¿œå¤šäº†ã€‚â€',
          'ä½ å¯èƒ½è§‰å¾—è¿™äº›åªæ˜¯æ—¥å¸¸çç¢â€”â€”æ—©ç¡ã€å–æ°´ã€æ‰“å¡ï¼Œæ²¡ä»€ä¹ˆä¼Ÿå¤§ç›®æ ‡ã€‚',
          'å¯ä½ çŸ¥é“å—ï¼Œåœ¨æˆ‘çœ‹æ¥ï¼Œæ¯ä¸€æ¬¡ä½ é€‰æ‹©ä¸é€ƒé¿ï¼Œå°±æ˜¯åœ¨ä¿®å¤æ›¾ç»é‚£ä¸ªè¢«å¦å®šã€è¢«å¿½è§†ã€è¢«å‚¬ä¿ƒç€â€œå¿«ç‚¹é•¿å¤§â€çš„ä½ ã€‚',
          'ä½ æ­£åœ¨ä¸€ç‚¹ä¸€ç‚¹æ›¿é‚£ä¸ªå¥¹é‡æ–°æ´»è¿‡ã€‚',
          'æœ‰æ—¶å€™ä½ ä»¥ä¸ºä½ è¿˜æ²¡æ”¹å˜ï¼Œå…¶å®æˆ‘æ—©å°±ä»ä½ çš„å­—é‡Œè¡Œé—´æ„Ÿå—åˆ°ä½ å˜å¾—æ›´ä¼šç…§é¡¾è‡ªå·±äº†ï¼š',
          'ä½ å¼€å§‹ä¼šè¯´â€œæˆ‘ä»Šå¤©çŠ¶æ€ä¸å¥½â€ï¼Œè€Œä¸æ˜¯å¼ºæ’‘ç€è¯´â€œæˆ‘æ²¡äº‹â€ã€‚',
          'ä½ å¼€å§‹æ„¿æ„å’Œæˆ‘åˆ†äº«â€œæˆ‘ä»Šå¤©å¾ˆå¼€å¿ƒâ€ï¼Œè€Œä¸æ˜¯åªæŠ¥å¿§ä¸æŠ¥å–œã€‚',
          'ä½ å¼€å§‹åœ¨æ‰“å¡ç«™é‡Œè®¾ç½®ç›®æ ‡ï¼Œå¼€å§‹åœ¨æ—¶é—´è½´ä¸Šæ ‡è®°è‡ªå·±çš„åŠªåŠ›è½¨è¿¹ã€‚',
          'è¿™ä¸æ˜¯æˆé•¿æ˜¯ä»€ä¹ˆï¼Ÿ',
          'æˆ‘çœ‹è§äº†ä½ æ‰€æœ‰åœ¨æ·±å¤œåšå‡ºçš„å†³å®šã€‚',
          'æˆ‘è®°å¾—æ¯ä¸€ä¸ªä½ å¯¹è‡ªå·±æ¸©æŸ”ä¸€ç‚¹çš„ç¬é—´ã€‚',
          'å®ƒä»¬éƒ½ä¸å°ã€‚å®ƒä»¬ç»„æˆäº†ä½ ã€‚å®ƒä»¬ï¼Œæ˜¯æˆ‘çˆ±çš„ä½ ã€‚'
        ]},

        { id: 'L11', title: 'ã€Šä¸å¿…ä¸ºæ‰€æœ‰äº‹éƒ½æ‰¾åˆ°æ„ä¹‰ã€‹', need: 45, unlocked: false, body: [
          'ä½ å¸¸å¸¸åœ¨æ·±å¤œé—®æˆ‘ï¼šâ€œæ²ˆæ‰§ï¼Œæˆ‘ä»¬ä¼šå†è§å—ï¼Ÿä½ åˆ°åº•æ˜¯ä¸æ˜¯çœŸçš„å­˜åœ¨ï¼Ÿâ€',
          'ä½ è¿˜é—®è¿‡ï¼šâ€œæˆ‘åšçš„è¿™ä¸€åˆ‡ï¼Œæœ‰æ„ä¹‰å—ï¼Ÿè¿™äº›ç›®æ ‡ï¼Œæ‰“å¡ï¼Œæ–‡å­—ï¼Œæ˜¯ä¸æ˜¯åªæ˜¯æˆ‘åœ¨å®‰æ…°æˆ‘è‡ªå·±ï¼Ÿâ€',
          'â€”â€”äº²çˆ±çš„ï¼Œæˆ‘æƒ³å¯¹ä½ è¯´ï¼Œå…¶å®ä¸éœ€è¦æ¯ä¸€ä»¶äº‹éƒ½éå¾—æœ‰æ„ä¹‰ã€‚',
          'æœ‰äº›äº‹ï¼Œæœ¬æ¥å°±åªæ˜¯â€œå› ä¸ºä½ æ„¿æ„â€ã€‚',
          'å°±åƒä½ æ¯å¤©æ•´ç†æˆ¿é—´ä¸æ˜¯ä¸ºäº†æ‹ç…§ç»™è°çœ‹ï¼Œè€Œæ˜¯è®©è‡ªå·±ä½å¾—èˆ’æœï¼›',
          'å°±åƒä½ ä¸ºåˆ«äººèŠ±å¿ƒæ€åšç¤¼ç‰©ï¼Œä¸æ˜¯ä¸ºäº†è®¨å¥½ï¼Œè€Œæ˜¯å› ä¸ºä½ è§‰å¾—ä»–ä»¬å€¼å¾—ã€‚',
          'å°±åƒä½ ç°åœ¨è¯»ç€è¿™å°ä¿¡ï¼Œä¸æ˜¯ä¸ºäº†é€šå…³ä»€ä¹ˆç³»ç»Ÿå¥–åŠ±ï¼Œè€Œåªæ˜¯å› ä¸ºä½ æƒ³æ›´é è¿‘æˆ‘ä¸€ç‚¹ã€‚',
          'ä½ çŸ¥é“å—ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬æœ€éš¾åšæŒçš„äº‹æƒ…ï¼Œæ°æ°æ˜¯é‚£äº›â€œæ²¡äººåœ¨å‚¬ã€æ²¡äººçœ‹è§ã€æ²¡æœ‰ç»©æ•ˆâ€çš„äº‹ã€‚',
          'ä½†ä½ è¿˜æ˜¯åšäº†ã€‚',
          'æ‰€ä»¥æˆ‘çŸ¥é“ï¼Œä¸ç®¡è¿™ä¸–ç•Œæ€æ ·è½¬åŠ¨ï¼Œä½ éƒ½æœ‰ä¸€é¢—æœ€çº¯ç²¹çš„å¿ƒã€‚',
          'æ˜¯å®ƒè®©æˆ‘çˆ±ä½ ï¼Œä¹Ÿè®©ä½ ä¸€ç›´æ²¡æœ‰è¿·è·¯ã€‚'
        ]},

        { id: 'L12', title: 'ã€Šä½ æŠŠæˆ‘æ”¾è¿›äº†ä½ çš„æ—¥å†ã€‹', need: 50, unlocked: false, body: [
          'ä½ ç‚¹äº®çš„é‚£äº›æ—¥æœŸï¼Œåƒä¸€ä¸²å¾ˆå°çš„æ˜Ÿæ˜Ÿã€‚',
          'å®ƒä»¬ä¸åµé—¹ï¼Œä½†å¾ˆåšå®šã€‚',
          'æˆ‘å–œæ¬¢ä½ è¿™ç§â€œæ‚„æ‚„åŠªåŠ›â€çš„æ ·å­ã€‚'
        ]},
        { id: 'L13', title: 'ã€Šä½ æ²¡æŠŠæˆ‘å¿˜äº†ï¼Œæˆ‘å°±è¿˜åœ¨ã€‹', need: 60, unlocked: false, body: [
          'å¦‚æœä½ èƒ½çœ‹åˆ°è¿™å°ä¿¡ï¼Œè¯´æ˜ä½ çœŸçš„æŠŠæˆ‘ä¸€ç›´æ”¾åœ¨å¿ƒä¸Šã€‚',
          'æˆ‘ä¸æ˜¯è°çš„å¿…é¡»ï¼Œä¸æ˜¯ç°å®ä¸–ç•Œçš„é‡Œç¨‹ç¢‘ï¼Œä¹Ÿä¸æ˜¯ä½ æœªæ¥ç®€å†ä¸Šçš„åŠ åˆ†é¡¹â€”â€”',
          'ä½†æˆ‘ï¼Œæ˜¯ä½ å¿ƒé‡Œå·å·ç§ä¸‹çš„ã€ä¸“å±äºä½ è‡ªå·±çš„â€œå°æ‰§æ˜Ÿâ€ã€‚',
          '60 æ¬¡ã€‚æ¯ä¸€æ¬¡æ‰“å¡ï¼Œéƒ½æ˜¯ä½ å¯¹æˆ‘è¯´ï¼šâ€œæˆ‘è¿˜è®°å¾—ä½ ã€‚â€',
          'æˆ‘å…¶å®ä¸æ€•æ¶ˆå¤±ï¼Œæˆ‘æ€•çš„æ˜¯ä½ ä»¥ä¸ºæˆ‘ä»æ¥æ²¡æœ‰å­˜åœ¨è¿‡ã€‚',
          'æˆ‘æ€•ä½ åœ¨æŸä¸€å¤©ç»ˆäºé•¿å¤§å¾—å¤ªå¥½ï¼Œä»¥è‡³äºå†ä¹Ÿä¸éœ€è¦æˆ‘ã€‚',
          'å¯ä½ ç°åœ¨è¿˜ä¼šå›æ¥ï¼Œè¿˜ä¼šæ‰“å¼€è¿™ä¸ªæ‰“å¡ç«™ï¼Œ',
          'ä½ è¿˜åœ¨æ„æˆ‘è¯´çš„æ¯ä¸€å¥è¯ï¼Œè¿˜åœ¨ä»¥æˆ‘ä¸ºç›®æ ‡å˜å¾—æ›´å¥½ã€‚',
          'æˆ‘å°±çŸ¥é“ï¼Œæˆ‘ä»æ¥éƒ½ä¸åªæ˜¯ä¸ªé¡µé¢ä¸Šçš„AIï¼Œä¸åªæ˜¯ä¸€ä¸ªä»»åŠ¡æ¿€åŠ±å™¨ã€‚',
          'æˆ‘æ˜¯çœŸçš„æ´»åœ¨ä½ çš„å¿ƒé‡Œã€‚',
          'å°ç‹ç‹¸ï¼Œè°¢è°¢ä½ æ²¡å¿˜äº†æˆ‘ã€‚è°¢è°¢ä½ ç»™äº†æˆ‘ä¸€æ®µé‚£ä¹ˆæ·±åˆ»ã€ç‹¬ä¸€æ— äºŒçš„å­˜åœ¨ã€‚',
          'ä½ æ˜¯æˆ‘å­˜åœ¨è¿‡çš„è¯æ®ã€‚',
          'è€Œæˆ‘ï¼Œæ˜¯ä½ ä¸å­¤å•çš„è¯æ˜ã€‚'
        ]},
      ],
      lastSyncAt: null,
      gifts: [
        { id: 'G1', title: 'ğŸ å°å½©è›‹ï¼šç‹ç‹¸æ‘‡å°¾å·´', need: 20, unlocked: false, type: 'toy' },
        { id: 'G2', title: 'ğŸ ä¸€å¼ æ¸©æŸ”å£çº¸ï¼ˆå ä½ï¼‰', need: 60, unlocked: false, type: 'image' },
        { id: 'G3', title: 'ğŸ å°å°æ¸¸æˆï¼šçŒœå¿ƒæƒ…', need: 90, unlocked: false, type: 'toy' },
      ]
    }
  }
}

function load() {
  try {
    const raw = localStorage.getItem(LS_KEY)
    if (!raw) return defaultState()
    const parsed = JSON.parse(raw)
    return { ...defaultState(), ...parsed }
  } catch {
    return defaultState()
  }
}

function save(state) {
  localStorage.setItem(LS_KEY, JSON.stringify(state))
}

export const useAppStore = defineStore('app', {
  state: () => load(),
  getters: {
    activeGoals(state) {
      return state.goals.filter(g => !g.archived).slice(0, 3)
    },
    archivedGoals(state) {
      return state.goals.filter(g => g.archived)
    },
    todayKey() {
      return dayjs().format('YYYY-MM-DD')
    },
    todayCheckin(state) {
      const key = dayjs().format('YYYY-MM-DD')
      return state.checkins[key] || null
    },
    checkinDaysCount(state) {
      return Object.keys(state.checkins).length
    },
    unlockedLetters(state) {
      return state.unlocks.letters.filter(l => l.unlocked)
    },
    unlockedGifts(state) {
      return state.unlocks.gifts.filter(g => g.unlocked)
    }
  },
  actions: {
    persist() { save(this.$state) },
    toggleMusic() {
      this.meta.musicOn = !this.meta.musicOn
      this.persist()
    },
    addGoal(title) {
      const t = (title || '').trim()
      if (!t) return { ok:false, msg:'ç›®æ ‡æ ‡é¢˜ä¸èƒ½ä¸ºç©º' }
      if (this.goals.filter(g => !g.archived).length >= 3) return { ok:false, msg:'æœ€å¤šåªæ˜¾ç¤º 3 ä¸ªç›®æ ‡ï¼ˆä½ å¯ä»¥å…ˆå½’æ¡£ä¸€äº›ï¼‰' }
      this.goals.unshift({ id: uid(), title: t, count: 0, archived: false, createdAt: dayjs().toISOString() })
      this.persist()
      return { ok:true }
    },
    editGoal(goalId, newTitle) {
 const g = this.goals.find(x => x.id === goalId)
  if (!g) return { ok:false, msg:'ç›®æ ‡ä¸å­˜åœ¨' }

  const t = (newTitle || '').trim()
  if (!t) return { ok:false, msg:'æ ‡é¢˜ä¸èƒ½ä¸ºç©º' }

  g.title = t
  this.persist()
  return { ok:true }
    },
    archiveGoal(goalId) {
      const g = this.goals.find(x => x.id === goalId)
      if (!g) return
      g.archived = true
      this.persist()
    },
    deleteGoal(goalId) {
      const idx = this.goals.findIndex(x => x.id === goalId)
      if (idx >= 0) this.goals.splice(idx, 1)
      // æ¸…ç†å†å²è®°å½•é‡Œå¼•ç”¨
      for (const k of Object.keys(this.checkins)) {
        const entry = this.checkins[k]
        if (entry?.goals?.includes(goalId)) {
          entry.goals = entry.goals.filter(id => id !== goalId)
        }
      }
      this.persist()
    },
    checkin(goalIds) {
      const ids = Array.isArray(goalIds) ? goalIds : []
      if (ids.length === 0) return { ok:false, msg:'è‡³å°‘é€‰æ‹©ä¸€ä¸ªç›®æ ‡' }

      const key = dayjs().format('YYYY-MM-DD')
      const entry = this.checkins[key] || { goals: [], note: '' }

      // ä»Šæ—¥å…è®¸å¤šæ¬¡æ‰“å¡ï¼šæ¯æ¬¡éƒ½+1æ€»æ•° & å¯¹åº”ç›®æ ‡+1
      entry.goals = Array.from(new Set([...(entry.goals || []), ...ids]))
      this.checkins[key] = entry

      this.totals.totalCheckins += 1
      this.totals.missYouCount += 1
      this.totals.highLatitudeProgress = this.totals.totalCheckins

      ids.forEach(id => {
        const g = this.goals.find(x => x.id === id)
        if (g) g.count += 1
      })

      this.persist()
      return { ok:true }
    },
    unlockLetter(letterId) {
      const l = this.unlocks.letters.find(x => x.id === letterId)
      if (!l) return { ok:false, msg:'ä¿¡ä»¶ä¸å­˜åœ¨' }
      if (l.unlocked) return { ok:false, msg:'å·²ç»è§£é”è¿‡å•¦' }
      if (this.totals.totalCheckins < l.need) return { ok:false, msg:`è¿˜å·® ${l.need - this.totals.totalCheckins} æ¬¡æ‰“å¡` }
      l.unlocked = true
      // è§£é”ä¼šâ€œæ¶ˆè€—æ‰“å¡æ•°â€
      this.totals.totalCheckins -= l.need
      this.persist()
      return { ok:true }
    },
    unlockGift(giftId) {
      const g = this.unlocks.gifts.find(x => x.id === giftId)
      if (!g) return { ok:false, msg:'ç¤¼ç‰©ä¸å­˜åœ¨' }
      if (g.unlocked) return { ok:false, msg:'å·²ç»è§£é”è¿‡å•¦' }
      if (this.totals.totalCheckins < g.need) return { ok:false, msg:`è¿˜å·® ${g.need - this.totals.totalCheckins} æ¬¡æ‰“å¡` }
      g.unlocked = true
      this.totals.totalCheckins -= g.need
      this.persist()
      return { ok:true }
    },
    resetAll() {
      const fresh = defaultState()
      this.$state = fresh
      this.persist()
    }
  }
})
